name: Build and Deploy

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

permissions:
  id-token: write
  contents: read

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./aws_infra
    outputs:
      ecr_repository_url: ${{ steps.terraform-output.outputs.ecr_url }}
      cluster_name: ${{ steps.terraform-output.outputs.cluster_name }}
      image_tag: ${{ steps.terraform-output.outputs.image_tag }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: true

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: us-east-1
        role-session-name: GitHubActions-${{ github.run_id }}
        role-duration-seconds: 3600
        audience: sts.amazonaws.com

  deploy-to-k8s:   # Fixed indentation
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, build-and-push]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
        aws-region: us-east-1
        role-session-name: GitHubActions-${{ github.run_id }}

    - name: Configure kubectl
      run: |
        aws eks update-kubeconfig --name ${{ needs.deploy-infrastructure.outputs.cluster_name }} --region us-east-1

    - name: Deploy to Kubernetes
      env:
        ECR_REGISTRY: ${{ needs.deploy-infrastructure.outputs.ecr_repository_url }}
        IMAGE_TAG: ${{ github.sha }}
        CLUSTER_NAME: ${{ needs.deploy-infrastructure.outputs.cluster_name }}  # Use the output variable
      run: |
        cd aws_infra
        
        # Get cluster info
        echo "Getting cluster information..."
        ROLE_ARN=$(aws eks describe-cluster --name $CLUSTER_NAME --query 'cluster.roleArn' --output text)
        
        # Get Node IAM Role ARN - use dynamic cluster name
        NODE_ROLE_ARN=$(aws iam get-role --role-name ${CLUSTER_NAME}-worker-node-role --query 'Role.Arn' --output text)
        
        # Get subnet information
        SUBNET_IDS=$(aws eks describe-cluster --name $CLUSTER_NAME \
          --query 'cluster.resourcesVpcConfig.subnetIds[]' \
          --output text)
        
        # Check for existing node groups
        echo "Checking EKS node groups..."
        NODE_GROUPS=$(aws eks list-nodegroups --cluster-name $CLUSTER_NAME --query 'nodegroups[*]' --output text || echo "")
        
        if [ -z "$NODE_GROUPS" ]; then
          echo "No node groups found. Creating default node group..."
          aws eks create-nodegroup \
            --cluster-name $CLUSTER_NAME \
            --nodegroup-name default-nodegroup \
            --scaling-config minSize=1,maxSize=3,desiredSize=2 \
            --subnets $SUBNET_IDS \
            --instance-types t3.medium \
            --node-role $NODE_ROLE_ARN \
            --ami-type AL2_x86_64
          
          echo "Waiting for nodegroup to be active..."
          aws eks wait nodegroup-active \
            --cluster-name $CLUSTER_NAME \
            --nodegroup-name default-nodegroup
        fi
        
        # Rest of deployment remains the same
        echo "Cleaning up old deployment resources..."
        kubectl delete deployment massage-website --ignore-not-found=true
        kubectl get pods -l app=massage-website -o name | xargs -r kubectl delete --force --grace-period=0
        kubectl delete rs -l app=massage-website --ignore-not-found=true
        
        echo "Applying manifests..."
        envsubst < k8s/deployment.yml | kubectl apply -f -
        kubectl apply -f k8s/service.yml
        kubectl apply -f k8s/ingress.yml
        
        echo "Checking pod status..."
        kubectl get pods -l app=massage-website
        kubectl describe pods -l app=massage-website
        
        echo "Waiting for deployment rollout..."
        kubectl rollout status deployment/massage-website --timeout=300s